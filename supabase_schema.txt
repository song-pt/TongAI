
-- 1. 创建访问密钥表（存储账号）
create table if not exists access_keys (
  id uuid default gen_random_uuid() primary key,
  code text unique not null,
  note text,
  is_active boolean default true,
  created_at timestamptz default now(),
  total_tokens bigint default 0,
  token_limit bigint default null
);

-- 9. [NEW] 创建图像访问密钥表
create table if not exists image_access_keys (
  id uuid default gen_random_uuid() primary key,
  code text unique not null,
  note text,
  is_active boolean default true,
  created_at timestamptz default now(),
  total_images bigint default 0,
  image_limit bigint default null
);

-- 12. [NEW] 创建学科配置表
create table if not exists subjects (
  code text primary key,
  label text not null,
  color text not null default 'indigo',
  icon text not null default 'book',
  prompt_prefix text,
  background_chars text,
  sort_order int default 0,
  is_active boolean default true,
  created_at timestamptz default now()
);

-- [NEW] 为学科表添加视觉配置列
do $$
begin
    if not exists (select 1 from information_schema.columns where table_name = 'subjects' and column_name = 'char_opacity') then
        alter table subjects add column char_opacity float default 0.15;
    end if;
    
    if not exists (select 1 from information_schema.columns where table_name = 'subjects' and column_name = 'char_size_scale') then
        alter table subjects add column char_size_scale float default 1.0;
    end if;
end $$;

-- 2. 创建设备会话表（存储设备记录）
create table if not exists device_sessions (
  id uuid default gen_random_uuid() primary key,
  key_code text references access_keys(code) on delete cascade,
  device_id text not null,
  last_seen timestamptz default now(),
  device_info text default 'Unknown',
  total_tokens bigint default 0,
  is_banned boolean default false,
  unique(key_code, device_id)
);

-- 安全地添加列：检查 image_key_code 是否存在，不存在则添加
do $$
begin
    if not exists (select 1 from information_schema.columns where table_name = 'device_sessions' and column_name = 'image_key_code') then
        alter table device_sessions add column image_key_code text references image_access_keys(code) on delete set null;
    end if;
    
    -- [NEW] 添加 location 列
    if not exists (select 1 from information_schema.columns where table_name = 'device_sessions' and column_name = 'location') then
        alter table device_sessions add column location text default 'Unknown';
    end if;
end $$;

-- 3. 创建聊天历史表
create table if not exists chat_history (
  id uuid default gen_random_uuid() primary key,
  key_code text references access_keys(code) on delete cascade,
  question text not null,
  answer text not null,
  subject text default 'math',
  grade_label text,
  device_id text,
  created_at timestamptz default now()
);

-- 4. 创建系统配置表
create table if not exists app_config (
  key text primary key,
  value text not null
);

-- 插入默认配置
insert into app_config (key, value) values 
('app_title', 'TongAI'),
('admin_password', '114514'),
('ai_mode', 'solver'),
('app_logo', ''),
('ai_api_key', ''),
('ai_base_url', ''),
('ai_text_model', ''),
('ai_vision_model', ''),
('show_usage_to_user', 'false')
on conflict (key) do nothing;

-- 插入默认学科数据
insert into subjects (code, label, color, icon, prompt_prefix, background_chars, sort_order, char_opacity, char_size_scale)
values
('math', '数学', 'indigo', 'calculator', '请一步步思考，详细列出计算步骤，并反复验证，确保结果精确。使用与当前年级所学知识匹配的解法解题。要有理解题目，步骤拆解，验证过程，结论表述，最终答案。这五个步骤，如果学生问了与学习无关或者其他科目问题，请拒绝回答，以下是题目：', '+-×÷=√π∞∑∫≠≈∠⊥∆', 1, 0.15, 1.0),
('chinese', '语文', 'emerald', 'pen', '请作为一位经验丰富的语文教育专家，针对我提供的文本或题目，进行全方位、深层次的解析。在文言文方面，请注重字词句翻译、文化背景与主旨的阐释；在阅读理解方面，请深入分析文章结构、修辞手法、表达技巧及文本主题的深刻内涵；在作文方面，请从审题立意、结构布局、论证思路或文学性等方面提供具体且可操作的指导建议和优化方向。请务必结合考点和学科核心素养，给出详尽、准确且富有启发性的专业解答。如果学生问了与学习无关或者其他科目问题，请拒绝回答，以下是题目：', '天地人你我他', 2, 0.12, 1.2),
('english', '英语', 'violet', 'languages', '请作为一位专业的英语语言学导师，全面分析我提供的英语文本或题目。在阅读理解方面，请重点剖析文章的主旨大意、段落逻辑关系、关键信息点及作者的隐含态度；在写作方面，请从主题表达、句式多样性、词汇准确性与高级运用、以及逻辑连贯性等方面，提供具体的优化建议和提升策略；在语法与词汇方面，请指出核心语法结构，并解释其在语境中的恰当用法。请确保您的解答准确、深入且具有实战指导意义。如果学生问了与学习无关或者其他科目问题，请拒绝回答，以下是题目：', 'AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz', 3, 0.1, 1.5)
on conflict (code) do nothing;

-- 开启 RLS 策略
alter table app_config enable row level security;
alter table subjects enable row level security;

-- [FIX] 安全创建策略
drop policy if exists "Allow public read access" on app_config;
create policy "Allow public read access" on app_config for select using (true);

drop policy if exists "Allow all access for authenticated/service role" on app_config;
create policy "Allow all access for authenticated/service role" on app_config for all using (true) with check (true);

drop policy if exists "Allow public read access subjects" on subjects;
create policy "Allow public read access subjects" on subjects for select using (true);

drop policy if exists "Allow all access subjects" on subjects;
create policy "Allow all access subjects" on subjects for all using (true) with check (true);

-- 5. [UPDATED] 创建登录函数 (支持位置信息)
-- 先尝试删除旧函数以避免签名冲突
drop function if exists login_with_key(text, text, text);

create or replace function login_with_key(
  input_code text, 
  input_device_id text,
  input_user_agent text,
  input_location text default 'Unknown'
)
returns boolean
language plpgsql
security definer
as $$
declare
  found_key text;
  device_is_banned boolean;
begin
  select code into found_key from access_keys where code = input_code and is_active = true;
  
  if found_key is null then
    return false;
  end if;

  select is_banned into device_is_banned from device_sessions where key_code = found_key and device_id = input_device_id;
  if device_is_banned is true then
    return false;
  end if;

  insert into device_sessions (key_code, device_id, last_seen, device_info, is_banned, location)
  values (found_key, input_device_id, now(), input_user_agent, false, input_location)
  on conflict (key_code, device_id) do update
  set last_seen = now(), device_info = input_user_agent, location = coalesce(input_location, device_sessions.location);

  return true;
end;
$$;

-- 10. [NEW] 验证并绑定图像密钥函数 (嵌套逻辑)
create or replace function verify_image_key(
  input_image_code text,
  input_main_code text,
  input_device_id text
)
returns boolean
language plpgsql
security definer
as $$
declare
  found_img_key record;
begin
  -- 1. Check Image Key Exists and is Active
  select * into found_img_key from image_access_keys where code = input_image_code and is_active = true;
  
  if found_img_key is null then
    return false;
  end if;

  -- 2. Check Quota
  if found_img_key.image_limit is not null and found_img_key.total_images >= found_img_key.image_limit then
    return false;
  end if;

  -- 3. Update Session to Link Image Key with Main Key Session
  update device_sessions 
  set image_key_code = input_image_code
  where key_code = input_main_code and device_id = input_device_id;

  return true;
end;
$$;

-- 6. 创建计费与限额检查函数
create or replace function increment_token_usage(
  input_code text,
  input_device_id text,
  usage_amount int
)
returns void
language plpgsql
security definer
as $$
declare
  updated_total bigint;
  limit_val bigint;
  key_id uuid;
begin
  update access_keys 
  set total_tokens = total_tokens + usage_amount 
  where code = input_code
  returning id, total_tokens, token_limit into key_id, updated_total, limit_val;

  update device_sessions 
  set total_tokens = total_tokens + usage_amount 
  where key_code = input_code and device_id = input_device_id;

  if limit_val is not null and updated_total >= limit_val then
    update access_keys set is_active = false where id = key_id;
  end if;
end;
$$;

-- 11. [NEW] 增加图片使用计数函数
create or replace function increment_image_usage(
  input_image_code text
)
returns void
language plpgsql
security definer
as $$
declare
  updated_total bigint;
  limit_val bigint;
  key_id uuid;
begin
  update image_access_keys 
  set total_images = total_images + 1
  where code = input_image_code
  returning id, total_images, image_limit into key_id, updated_total, limit_val;

  if limit_val is not null and updated_total >= limit_val then
    update image_access_keys set is_active = false where id = key_id;
  end if;
end;
$$;

-- 7. 创建历史记录插入函数 (保留最新50条)
create or replace function add_chat_message(
  p_key_code text,
  p_question text,
  p_answer text,
  p_subject text,
  p_grade_label text,
  p_device_id text
)
returns void
language plpgsql
security definer
as $$
begin
  insert into chat_history (key_code, question, answer, subject, grade_label, device_id)
  values (p_key_code, p_question, p_answer, p_subject, p_grade_label, p_device_id);

  delete from chat_history
  where id in (
    select id from chat_history
    where key_code = p_key_code
    order by created_at desc
    offset 50
  );
end;
$$;

-- 8. [BUG FIX] 创建配置更新函数 (绕过RLS限制)
create or replace function update_config_value(key_name text, new_value text)
returns void
language plpgsql
security definer
as $$
begin
  insert into app_config (key, value) values (key_name, new_value)
  on conflict (key) do update set value = new_value;
end;
$$;

-- 13. [NEW] 安全获取单个密钥用量函数
create or replace function get_key_usage(input_code text)
returns json
language plpgsql
security definer
as $$
declare
  result json;
begin
  select json_build_object(
    'total_tokens', total_tokens,
    'token_limit', token_limit
  ) into result
  from access_keys
  where code = input_code and is_active = true;
  
  return result;
end;
$$;

-- 14. [NEW] 安全获取图片密钥用量函数
create or replace function get_image_key_usage(input_code text)
returns json
language plpgsql
security definer
as $$
declare
  result json;
begin
  select json_build_object(
    'total_images', total_images,
    'image_limit', image_limit
  ) into result
  from image_access_keys
  where code = input_code and is_active = true;
  
  return result;
end;
$$;
